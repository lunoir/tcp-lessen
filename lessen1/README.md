# Lessen1 Wiresharkを使ってHTTP通信を解析する

## 1. Wiresharkとは

パケットキャプチャして解析できるGUIツールです。
Etherealと呼ばれていたツールが元になっています。

## 2. Wiresharkインストール

https://www.wireshark.org/

上記からダウンロードもしくはbrewで入れる

```sh
$ brew cask install wireshark
```

起動してキャプチャができない的なメッセージが出た場合は ChmodBPFプラグインをインストールします。
wiresharkのバグのようです。
GUIの場合は画面にメッセージが表示されるので従ってください。
brewでインストールした場合は同様にbrewでインストールしてください。

```sh
$ brew cask install wireshark-chmodbpf
```

## 3. Local環境にWebサーバを立ち上げる

Dockerで立ち上げます。

```sh
$ docker-compose up --build
```

## 4. Wiresharkでパケットキャプチャする

Wiresharkを起動させるとNICの選択が出てきます。
NICリストが空の場合はWiresharkインストールで書いてあるとおりChmodBPプラグインをインストールしてください。

さて、Dockerで立ち上げたWebサーバと通信しているインターフェイスはどれでしょうか。
`docker0` でしょうか？
インターフェイスを確認してみます。

```sh
$ ifconfig
```

`docker0` インターフェイスはありましたでしょうか？
無いと思います。
Macには制約があり `docker0` ブリッジネットワークは存在しません。

https://docs.docker.com/docker-for-mac/networking/

Wiresharkでキャプチャすべきインターフェイスは `lo(Loopback)` となります。

## 5. Web通信の絞り込み

それでは、Webサーバと通信してください。
ブラウザだと `http://localhost:8080/` curlなら `$ curl localhost:8080` のように入力してください。

初期に画面を開いた状態では、 `lo` と通信する全てのパケットが表示されているため、どれがWebサーバと通信しているパケットなのか分かりません。
そこで情報を絞り込みます。
クエリ入力バーに下記を入力してみてください。

```query
tcp.port == 8080
```

これで情報がすっきりしました。
Webサーバは `8080` ポートで起動しているため、このポート宛の通信のみに情報を絞り込んだ状態です。

## 6. tcpの超基礎

通信内容を見る前に、tcpの超基礎を知っておく必要があります。
tcpはコネクション型プロトコルです。
ちなみにtcpは `Transmission Control Protocol` の略です。
そのため本体のデータ（今回の場合はHTTPデータ）を転送する前にコネクションを確立する必要があります。
このコネクションの確立は3way handshakeで行われます。
ざっくりASCIIで描くと下記な感じです。

```
Client              Server
  |                   |
  | ---- SYN -------> |  1: 通信始めるよ
  |                   |
  | <--- SYN, ACK --- |  2: 通信開始了解です
  |                   |
  | ---- ACK -------> |  3: 通信開始了解を受け取ったからデータ送るよ
  |                   |
```

コネクション終了時は下記の感じです。

```
Client              Server
  |                   |
  | ---- FIN, ACK --> |  1: 通信終了するよ
  |                   |
  | <--- ACK -------- |  2: 通信終了了解です
  | <--- FIN, ACK --- |  3: 通信終了するよ
  |                   |
  | ---- ACK -------> |  4: 通信終了了解です
  |                   |
```

SYN/ACK/FIN: 通信の意味を定義するコードビットと呼ばれるフラグ

## 7. 通信内容を見てみる

通信データ時系列順にリスト表示されている項目を見ると、コネクション関連のSYNやらFINやらが先頭と最後に表示されているのがわかります。
肝心のHTTPデータ通信はそれらに挟まれた真ん中に存在します。

Wiresharkはよくあるプロトコル（HTTPとか）は自動的に解析して表示してくれます。
通信データリストの `Info` 項目を見ると、 `GET / HTTP/1.1` や `HTTP/1.1 200 OK` といった表示があります。
これがHTTP通信したデータです。

リストを選択するとデータの中身が下のwindowに表示されます。
バイナリデータの右側にASCII文字列に変換されたものが表示されていると思います。
その内容はブラウザ（もしくはcurl）のリクエストデータとレスポンスデータと同じものが入っているはずです。
表示されていない人は `View -> Packet Bytes` チェックをONにしてください。

また、WiresharkがHTTPを解析して構造分けした内容が表示されているwindowもあります。
表示されてない人は `View -> Packet Details` チェックをONにしてください。
このwindowの `Hypertext Transfer Protocol` を開くと、各種ヘッダー情報などが解析されて個別に見れるようになっています。
また、それらのデータがパケットのバイナリデータのどこに該当するかもハイライト表示されていると思います。

# まとめ

Lessen1ではパケットキャプチャアプリであるWiresharkを少し使ってHTTP通信の中身を見てみました。
なんとなく使い方とTCP通信こうなってるんだという雰囲気は掴めたと思います。
