# TCP基礎の基礎講座

細かいところや歴史的経緯は省略します。
IPもセットで説明してる箇所はありますが、あまり深くは突っ込みません。

## OSI参照モデル

有名なアレです。
1層から7層で構成されます。
ここではあえてLayerと表現します。
ちょっとした理由でですが、それに関しては後で説明します。

### OSI参照モデル

```
Layer 1: 物理
Layer 2: データリンク
Layer 3: ネットワーク
Layer 4: トランスポート
Layer 5: セッション
Layer 6: プレゼンテーション
Layer 7: アプリケーション
```

## OSI参照モデルとTCP/IP

TCP/IPがOSI参照モデルのどこに該当するかというと、Layer3とLayer4に該当します。

モデルというとWebプログラミングの世界ではMVCを思い浮かべ、DB処理やビジネスロジック処理などの「実装」をイメージする人が多いと思いますが、モデルとは本来システムを理解するために用いられる「表現」です（諸説ありますが、あえて個人的な偏見で断言させてもらいました）。

で、TCP/IPはOSI参照モデル Layer3/4 の「実装」になります。
実はこの表現は不正確で、より正確にはTCP/IP用のモデルが存在します。
TCP/IP階層モデルがOSI参照モデルと互換性（と言っていいのかどうか）があるため混同する人も多いですが、この２つのモデルはそれぞれ対象としているものが微妙に異なるので注意してください。

### TCP/IP階層モデル

```
Layer 1: ハードウェア
Layer 2: ネットワークインターフェース
Layer 3: インターネット
Layer 4: トランスポート
Layer 5: アプリケーション
```

### OSI参照モデルとTCP/IP階層モデルの互換

```
OSI参照モデルLayer 1 <-> TCP/IP階層モデルLayer 1
OSI参照モデルLayer 2 <-> TCP/IP階層モデルLayer 2
OSI参照モデルLayer 3 <-> TCP/IP階層モデルLayer 3
OSI参照モデルLayer 4 <-> TCP/IP階層モデルLayer 4
OSI参照モデルLayer 5 <-> TCP/IP階層モデルLayer 5
OSI参照モデルLayer 6 <-> TCP/IP階層モデルLayer 5
OSI参照モデルLayer 7 <-> TCP/IP階層モデルLayer 5
```

## 余談１: スイッチ/ルーター

`層` をあえて `Layer` と表現しましたが、その理由は下記にあります。

通信の経路を変更するときに `スイッチ` や `ルーター` を導入します。
これらを `L2/L3/L7スイッチ` と呼ぶ人やサイトがあると思います。
この `L` は `Layer` を表しており、`数字` は `OSI参照モデルのどこに位置しているか` を表しています。
つまり、

```
Layer2スイッチ: OSI参照モデルLayer2を処理する機器／ソフトウェア（スイッチ）
Layer3スイッチ: OSI参照モデルLayer3を処理する機器／ソフトウェア（ルーター）
Layer7スイッチ: OSI参照モデルLayer7を処理する機器／ソフトウェア（ルーター、もしくはリバースプロキシ）
```

となります。

## TCPの特徴

ざっくり言うと、信頼性のある通信が可能です。
それらは下記で実現されてます。

- コネクションの確立
- 誤り検出
- 輻輳制御
- などなど

その代償として余分な通信やデータをやり取りする必要があり、品質よりもリアルタイム性を求められる通信には向いていません。
まあ、パフォーマンスが犠牲になっていると言っても、相当厳しい条件下以外では十分な性能を持っています。

## TCPの通信

TCPはLessen1で軽く解説した3way handshakeによるコネクション確立などに見るデータのやりとりの決まりごとと、TCPヘッダーに見るデータ構造の決まりごとを使って通信を行います。
TCPヘッダーについては後述します。
ここではデータのやりとりの決まりごとのうち、代表的なものを簡単に解説します。

### コネクション開始 - 3way handshake -

Lessen1で説明したものです。
コネクションを開始するときに3つの通信を行います。
SYN/ACK/FINフラグの具体的なデータはTCPヘッダーの説明で行いますのでここでは省略します。

#### コネクション開始

```
Client              Server
  |                   |
  | ---- SYN -------> |  1: 通信始めるよ
  |                   |
  | <--- SYN, ACK --- |  2: 通信開始了解です
  |                   |
  | ---- ACK -------> |  3: 通信開始了解を受け取ったからデータ送るよ
  |                   |
```

#### コネクション終了

```
Client              Server
  |                   |
  | ---- FIN, ACK --> |  1: 通信終了するよ
  |                   |
  | <--- ACK -------- |  2: 通信終了了解です
  | <--- FIN, ACK --- |  3: 通信終了するよ
  |                   |
  | ---- ACK -------> |  4: 通信終了了解です
  |                   |
```

### 確認応答

### 


## TCPのヘッダーフォーマット

TCP通信でやり取りするデータ構造（TCPヘッダー）を見ていきます。
TCPヘッダーをASCIIで表現するの難しいので下記サイトなどを参照してください。

https://ja.wikipedia.org/wiki/Transmission_Control_Protocol#TCP%E3%82%BB%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88%E6%A7%8B%E9%80%A0

では、Wiresharkでパケットキャプチャした実際のデータを見てみましょう。
下記はHTTPでGETリクエストを送った箇所です。

```
0000   02 00 00 00 45 00 00 82 00 00 40 00 40 06 00 00   ....E.....@.@...
0010   7f 00 00 01 7f 00 00 01 cb 74 1f 90 a0 e9 a6 44   .........t.....D
0020   4c 34 73 0d 80 18 18 eb fe 76 00 00 01 01 08 0a   L4s......v......
0030   13 f4 ed bd 13 f4 ed bd 47 45 54 20 2f 20 48 54   ........GET / HT
0040   54 50 2f 31 2e 31 0d 0a 48 6f 73 74 3a 20 6c 6f   TP/1.1..Host: lo
0050   63 61 6c 68 6f 73 74 3a 38 30 38 30 0d 0a 55 73   calhost:8080..Us
0060   65 72 2d 41 67 65 6e 74 3a 20 63 75 72 6c 2f 37   er-Agent: curl/7
0070   2e 35 34 2e 30 0d 0a 41 63 63 65 70 74 3a 20 2a   .54.0..Accept: *
0080   2f 2a 0d 0a 0d 0a                                 /*....
```

このデータを分解していきます。

`02 00 00 00` : イーサネットフレームのタイプ（説明略）

イーサネットフレームはOSI参照モデルもしくはTCP/IP階層モデルのLayer2の領域になります。
オンプレ環境を構築したりk8sのパケットを追う（VXLAN）場合はこの領域の知識が必要になりますが、普通に使う分には気にしなくても大丈夫です。

`45 00 00 82 00 00 40 00 40 06 00 00 7f 00 00 01 7f 00 00 01` : IPヘッダー（説明略）

TCP/IPのIPの部分です。
送信元IPとかが入ってます。

以下がTCPヘッダーになります。

`cb 74 1f 90 a0 e9 a6 44 4c 34 73 0d 80 18 18 eb fe 76 00 00 01 01 08 0a 13 f4 ed bd 13 f4 ed bd` : TCPヘッダー

これをさらに細かく見ていきます。

`cb 74` : 送信元ポート（52084）
`1f 90` : 送信先ポート（8080）
`a0 e9 a6 44` : シーケンス番号
`4c 34 73 0d` : 確認応答番号
`80` : ヘッダー長（厳密には `8` ）
`80 18` : フラグ（厳密には `80` の `8` を除く）
          フラグを分解すると `000 0 0 0 0 1 1 0 0 0` となる。 `Acknowledgment` と `Push` フラグがONになっている
`18 eb` : ウィンドウサイズ
`fe 76` : チェックサム
`00 00` : 緊急ポインタ
`01 01 08 0a 13 f4 ed bd 13 f4 ed bd` : オプション

Wiresharkの構造解析ウィンドウにはこれらを自動的に解析した結果が表示されますので確認してみてください。
アプリケーションエンジニア的にTCPヘッダーで特筆すべきは `ウィンドウサイズ` になります。
インターネット爆速！みたいに謳っているソフトウェアが昔ありましたが（今あるかは知らない）、このウィンドウサイズを調整することでパフォーマンスを上げることが可能です。
また、TCPヘッダー以降がデータグラムになります。データグラムの中身がLessen1で見たHTTPとなります。

## 余談２: TCPの仕組みを利用した攻撃

### SYN Flood攻撃

SYNパケットを大量に送りつける。
SYNパケットを受け取るとサーバ側はタイムアウトまでリソースを割り当て続けるため、SYNパケットのみを大量に送りつけてリソースを枯渇させることができる。
対策としてはOSのSYN Flood対策オプションを有効化する、タイムアウト値を短くする、NIDSを導入するなどある。

### TCPシーケンス番号予測攻撃

説明が面倒なのでWikipedia参照。TCP/IPの仕様知ってないと分かりづらい。
https://ja.wikipedia.org/wiki/TCP%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9%E7%95%AA%E5%8F%B7%E4%BA%88%E6%B8%AC%E6%94%BB%E6%92%83
攻撃可能条件が厳しいが、可能である場合はspoofingができるのでかなりやばい。
セッションハイジャックとも言われる。

### IP Spoofing

TCPシーケンス番号予測攻撃と似た手段を用いるが、こちらは外部から攻撃可能である。
説明面倒なのでWikidpedia参照。TCP/IPの仕様知ってないと分かりづらい。
https://ja.wikipedia.org/wiki/IP%E3%82%B9%E3%83%97%E3%83%BC%E3%83%95%E3%82%A3%E3%83%B3%E3%82%B0
これが出来ればIP制限を回避することも可能。

## 余談3: QUIC

Web業界で話題にあがるQUICプロトコルですが、これは厳密にはLayer4のプロトコルではありません。
これはUDP上に構築されたプロトコルになります。QUICの `U` はUDPの `U` です。
そのためLayer4レベルでの誤り検出とか輻輳制御はなされていません。
新しいLayer4レベルのプロトコルを作ると、対応する物理機器やソフトウェアの準備が大変すぎて使われないというのがUDP上に構築した理由らしいです。
